# See https://k9scli.io/topics/plugins/
plugins:

  # https://github.com/derailed/k9s/issues/1228#issuecomment-975471842
  # Henning C. Nielsen
  #   - Added scope to also be able to show logs for a single container in the container scope of a pod.
  #   - Added edit-secret
  
  # Shows the full log content and tails it
  raw-logs-follow:
    shortCut: Ctrl-L
    description: logs -f
    scopes:
    - po
    command: kubectl
    background: false
    args:
    - logs
    - -f
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT

  raw-container-logs-follow:
    shortCut: Ctrl-L
    description: logs -f
    scopes:
    - containers
    command: kubectl
    background: false
    args:
    - logs
    - -f
    - $POD
    - -n
    - $NAMESPACE
    - -c
    - $NAME
    - --context
    - $CONTEXT

  # Loads the full log in less instead of only the head tail
  # or a number of minutes which currently is the only default option in k9s
  log-less:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -r'
    - dummy-arg
    - kubectl
    - logs
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT

  log-container-less:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -r'
    - dummy-arg
    - kubectl
    - logs
    - $POD
    - -n
    - $NAMESPACE
    - -c
    - $NAME
    - --context
    - $CONTEXT
  
  # https://github.com/derailed/k9s/issues/1017
  # https://github.com/rajatjindal/kubectl-modify-secret
  edit-secret:
    shortCut: Ctrl-X
    confirm: false
    description: "Edit Decoded Secret"
    scopes:
      - secrets
    command: kubectl
    background: false
    args:
      - modify-secret
      - --namespace
      - $NAMESPACE
      - --context
      - $CONTEXT
      - $NAME

  ############################################################
  # From https://github.com/derailed/k9s/tree/master/plugins #
  ############################################################

  ###################
  # start dive.yaml #
  ###################
  dive:
    shortCut: d
    confirm: false
    description: "Dive image"
    scopes:
      - containers
    command: dive
    background: false
    args:
      - $COL-IMAGE
  #################
  # end dive.yaml #
  #################

  ###########################
  # start watch-events.yaml #
  ###########################
  watch-events:
    shortCut: Shift-E
    confirm: false
    description: Get Events
    scopes:
    - all
    command: sh
    background: false
    args:
    - -c
    - "watch -n 5 kubectl get events --context $CONTEXT --namespace $NAMESPACE --field-selector involvedObject.name=$NAME"
  #########################
  # end watch-events.yaml #
  #########################

  ######################
  # start openssl.yaml #
  ######################
  secret-openssl-ca:
    shortCut: Ctrl-O
    confirm: false
    description: Openssl ca.crt
    scopes:
      - secrets
    command: bash
    background: false
    args:
      - -c
      - kubectl get secret --context $CONTEXT -n $NAMESPACE $NAME -o jsonpath='{.data.ca\.crt}' | base64 -d | openssl storeutl -noout -text -certs /dev/stdin |& less

  secret-openssl-tls:
    shortCut: Shift-O
    confirm: false
    description: Openssl tls.crt
    scopes:
      - secrets
    command: bash
    background: false
    args:
      - -c
      - kubectl get secret --context $CONTEXT -n $NAMESPACE $NAME -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl storeutl -noout -text -certs /dev/stdin |& less
  ####################
  # end openssl.yaml #
  ####################

  ###################
  # start flux.yaml #
  ###################
  toggle-helmrelease:
    shortCut: Shift-T
    confirm: true
    scopes:
      - helmreleases
    description: Toggle to suspend or resume a HelmRelease
    command: bash
    background: false
    args:
      - -c
      - >-
        suspended=$(kubectl --context $CONTEXT get helmreleases -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1);
        verb=$([ $suspended = "true" ] && echo "resume" || echo "suspend");
        flux
        $verb helmrelease
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  toggle-kustomization:
    shortCut: Shift-T
    confirm: true
    scopes:
      - kustomizations
    description: Toggle to suspend or resume a Kustomization
    command: bash
    background: false
    args:
      - -c
      - >-
        suspended=$(kubectl --context $CONTEXT get kustomizations -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1);
        verb=$([ $suspended = "true" ] && echo "resume" || echo "suspend");
        flux
        $verb kustomization
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-git:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - gitrepositories
    command: bash
    background: false
    args:
      - -c
      - >-
        flux
        reconcile source git
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-hr:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - helmreleases
    command: bash
    background: false
    args:
      - -c
      - >-
        flux
        reconcile helmrelease
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-helm-repo:
    shortCut: Shift-Z
    description: Flux reconcile
    scopes:
      - helmrepositories
    command: bash
    background: false
    confirm: false
    args:
      - -c
      - >-
        flux
        reconcile source helm
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-oci-repo:
    shortCut: Shift-Z
    description: Flux reconcile
    scopes:
      - ocirepositories
    command: bash
    background: false
    confirm: false
    args:
      - -c
      - >-
        flux
        reconcile source oci
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-ks:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - kustomizations
    command: bash
    background: false
    args:
      - -c
      - >-
        flux
        reconcile kustomization
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-ir:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imagerepositories
    command: sh
    background: false
    args:
      - -c
      - >-
        flux
        reconcile image repository
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  reconcile-iua:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imageupdateautomations
    command: sh
    background: false
    args:
      - -c
      - >-
        flux
        reconcile image update
        --context $CONTEXT
        -n $NAMESPACE $NAME
        | less -K

  trace:
    shortCut: Shift-P
    confirm: false
    description: Flux trace
    scopes:
      - all
    command: bash
    background: false
    args:
      - -c
      - >-
        resource=$(echo $RESOURCE_NAME | sed -E 's/ies$/y/' | sed -E 's/ses$/se/' | sed -E 's/(s|es)$//g')
        flux
        trace
        --context $CONTEXT
        --kind $resource
        --api-version $RESOURCE_GROUP/$RESOURCE_VERSION
        --namespace $NAMESPACE $NAME
        | less -K

  # credits: https://github.com/fluxcd/flux2/discussions/2494
  get-suspended-helmreleases:
    shortCut: Shift-S
    confirm: false
    description: Suspended Helm Releases
    scopes:
      - helmrelease
    command: sh
    background: false
    args:
      - -c
      - >-
        kubectl get
        --context $CONTEXT
        --all-namespaces
        helmreleases.helm.toolkit.fluxcd.io -o json
        | jq -r '.items[] | select(.spec.suspend==true) | [.metadata.namespace,.metadata.name,.spec.suspend] | @tsv'
        | less -K

  get-suspended-kustomizations:
    shortCut: Shift-S
    confirm: false
    description: Suspended Kustomizations
    scopes:
      - kustomizations
    command: sh
    background: false
    args:
      - -c
      - >-
        kubectl get
        --context $CONTEXT
        --all-namespaces
        kustomizations.kustomize.toolkit.fluxcd.io -o json
        | jq -r '.items[] | select(.spec.suspend==true) | [.metadata.name,.spec.suspend] | @tsv'
        | less -K
  #################
  # end flux.yaml #
  #################
